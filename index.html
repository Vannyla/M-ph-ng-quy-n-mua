<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mô Phỏng Quyền Mua & Cổ Tức</title>
    <!-- Tải Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
    </style>
</head>
<body class="bg-gray-100 p-4 md:p-8">

    <div class="max-w-5xl mx-auto bg-white rounded-lg shadow-lg overflow-hidden">
        <!-- TIÊU ĐỀ -->
        <div class="bg-blue-800 p-5">
            <h1 class="text-2xl md:text-3xl font-bold text-white text-center">
                Mô phỏng Quyền Mua & Cổ Tức
            </h1>
            <p class="text-center text-blue-100 text-sm mt-1">Công cụ hỗ trợ nhà đầu tư ra quyết định</p>
        </div>

        <!-- KHỐI NHẬP LIỆU -->
        <div class="p-6 md:p-8">
            <h2 class="text-xl font-bold text-blue-900 border-b-2 border-blue-200 pb-2 mb-6">
                PHẦN 1: NHẬP THÔNG TIN GIAO DỊCH
            </h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Cột trái -->
                <div>
                    <div class="mb-4">
                        <label for="currentShares" class="block text-sm font-medium text-gray-700 mb-1">1. Số lượng cổ phiếu (N)</label>
                        <input type="number" id="currentShares" placeholder="Số CP dự định mua hoặc đang nắm giữ" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div class="mb-4">
                        <label for="priceBefore" class="block text-sm font-medium text-gray-700 mb-1">2. Giá đóng cửa trước GDKHQ (P)</label>
                        <input type="number" id="priceBefore" placeholder="Ví dụ: 16650" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div class="mb-4">
                        <label for="cashDividend" class="block text-sm font-medium text-gray-700 mb-1">3. Cổ tức bằng tiền / CP (C)</label>
                        <input type="number" id="cashDividend" placeholder="Để 0 nếu không có" value="0" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>

                <!-- Cột phải -->
                <div>
                    <div class="mb-4">
                        <label for="stockDividendRatio" class="block text-sm font-medium text-gray-700 mb-1">4. Tỷ lệ cổ tức/thưởng bằng CP (%)</label>
                        <input type="number" id="stockDividendRatio" placeholder="Để 0 nếu không có" value="0" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">5. Tỷ lệ thực hiện quyền mua (Để trống nếu chỉ chia cổ tức)</label>
                        <div class="flex items-center space-x-2">
                            <label for="rightsRatioOld" class="text-sm">Cũ:</label>
                            <input type="number" id="rightsRatioOld" placeholder="Ví dụ: 300" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <label for="rightsRatioNew" class="text-sm">Mới:</label>
                            <input type="number" id="rightsRatioNew" placeholder="Ví dụ: 200" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                    <div class="mb-4">
                        <label for="issuePrice" class="block text-sm font-medium text-gray-700 mb-1">6. Giá phát hành ưu đãi (Pa)</label>
                        <input type="number" id="issuePrice" placeholder="Để 0 nếu không có quyền mua" value="0" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
            </div>
            
            <!-- Nút Tính Toán -->
            <div class="mt-6 text-center">
                <button id="calculateBtn" class="w-full md:w-1/2 bg-blue-600 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-blue-700 transition duration-300 ease-in-out">
                    PHÂN TÍCH
                </button>
            </div>
        </div>

        <!-- KHỐI KẾT QUẢ (Ẩn ban đầu) -->
        <div id="results" class="hidden">
            <!-- Phần 2: Kết quả tính toán (Chung cho cả 2) -->
            <div class="p-6 md:p-8 bg-gray-50">
                <h2 class="text-xl font-bold text-blue-900 border-b-2 border-blue-200 pb-2 mb-6">
                    PHẦN 2: KẾT QUẢ TÍNH TOÁN
                </h2>
                <div class="bg-white p-6 rounded-lg shadow-md border border-blue-100">
                    <h3 class="text-lg font-semibold text-gray-800 mb-2">Giá cổ phiếu điều chỉnh (P')</h3>
                    <p id="adjustedPriceResult" class="text-3xl font-bold text-blue-600 mb-4">
                        <!-- 38,000 VND -->
                    </p>
                    <div class="bg-gray-100 p-4 rounded-md">
                        <h4 class="font-semibold text-gray-700 mb-2">Diễn giải công thức:</h4>
                        <p class="text-sm text-gray-600 italic">
                            Giá điều chỉnh (P') = (P + Pa * R2 - C) / (1 + R1 + R2)
                        </p>
                        <div id="explanation" class="text-sm text-gray-600 mt-2 space-y-1">
                            <!-- Diễn giải chi tiết sẽ được chèn vào đây -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- KỊCH BẢN 1: CÓ QUYỀN MUA -->
            <div id="rightsIssueAnalysis" class="hidden">
                <!-- Phần 3: So sánh quyết định -->
                <div class="p-6 md:p-8">
                    <h2 class="text-xl font-bold text-blue-900 border-b-2 border-blue-200 pb-2 mb-6">
                        PHẦN 3: SO SÁNH QUYẾT ĐỊNH (TẠM TÍNH TẠI NGÀY GDKHQ)
                    </h2>
                    <div class="overflow-x-auto">
                        <table class="min-w-full border border-gray-200 rounded-lg">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="p-4 text-left text-sm font-semibold text-gray-700">Tiêu chí so sánh</th>
                                    <th class="p-4 text-left text-sm font-semibold text-white bg-green-600">
                                        ✅ THỰC HIỆN QUYỀN MUA
                                    </th>
                                    <th class="p-4 text-left text-sm font-semibold text-white bg-red-600">
                                        ❌ TỪ BỎ QUYỀN MUA
                                    </th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                <tr>
                                    <td class="p-4 font-medium text-gray-600">Số CP nắm giữ ban đầu</td>
                                    <td id="val-n1" class="p-4"></td>
                                    <td id="val-n2" class="p-4"></td>
                                </tr>
                                <tr>
                                    <td class="p-4 font-medium text-gray-600">Số CP thưởng/cổ tức</td>
                                    <td id="val-bonus1" class="p-4"></td>
                                    <td id="val-bonus2" class="p-4"></td>
                                </tr>
                                <tr>
                                    <td class="p-4 font-medium text-gray-600">Số CP được mua thêm</td>
                                    <td id="val-new1" class="p-4 font-semibold text-green-700"></td>
                                    <td id="val-new2" class="p-4 font-semibold text-red-700">0 CP</td>
                                </tr>
                                <tr class="bg-gray-50">
                                    <td class="p-4 font-bold text-gray-800">Tổng số CP sau GDKHQ</td>
                                    <td id="val-total-n1" class="p-4 font-bold text-lg text-green-700"></td>
                                    <td id="val-total-n2" class="p-4 font-bold text-lg text-red-700"></td>
                                </tr>
                                <tr>
                                    <td class="p-4 font-medium text-gray-600">Tiền mặt nhận (Cổ tức)</td>
                                    <td id="val-cash-in1" class="p-4"></td>
                                    <td id="val-cash-in2" class="p-4"></td>
                                </tr>
                                <tr>
                                    <td class="p-4 font-medium text-gray-600">Tiền mặt nộp (Mua CP)</td>
                                    <td id="val-cash-out1" class="p-4 text-red-600"></td>
                                    <td id="val-cash-out2" class="p-4">0 VND</td>
                                </tr>
                                <tr class="bg-gray-50">
                                    <td class="p-4 font-bold text-gray-800">Thay đổi tiền mặt ròng</td>
                                    <td id="val-net-cash1" class="p-4 font-bold text-lg"></td>
                                    <td id="val-net-cash2" class="p-4 font-bold text-lg"></td>
                                </tr>
                                <tr class="bg-blue-50 border-t-2 border-blue-200">
                                    <td class="p-4 font-bold text-blue-800">
                                        Lợi ích / Lỗ tạm tính<br>
                                        <span class="text-xs font-normal">(Chênh lệch P' và Pa)</span>
                                    </td>
                                    <td id="val-benefit" class="p-4 font-bold text-2xl text-green-600"></td>
                                    <td id="val-loss" class="p-4 font-bold text-2xl text-red-600"></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Phần 4: Diễn giải & Khuyến nghị -->
                <div class="p-6 md:p-8">
                    <h2 class="text-xl font-bold text-blue-900 border-b-2 border-blue-200 pb-2 mb-6">
                        PHẦN 4: DIỄN GIẢI & KHUYẾN NGHỊ (TRƯỜNG HỢP CÓ QUYỀN MUA)
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                        <!-- Kịch bản 1: Thực hiện -->
                        <div class="bg-green-50 border-l-4 border-green-500 p-4 rounded-r-lg shadow">
                            <h4 class="font-bold text-lg text-green-800 mb-2">✅ KỊCH BẢN 1: THỰC HIỆN QUYỀN</h4>
                            <p id="dynamic-reco-1" class="text-sm text-gray-700 space-y-2">
                                <!-- Nội dung động -->
                            </p>
                        </div>
                        <!-- Kịch bản 2: Từ bỏ -->
                        <div class="bg-red-50 border-l-4 border-red-500 p-4 rounded-r-lg shadow">
                            <h4 class="font-bold text-lg text-red-800 mb-2">❌ KỊCH BẢN 2: TỪ BỎ QUYỀN</h4>
                            <p id="dynamic-reco-2" class="text-sm text-gray-700 space-y-2">
                                <!-- Nội dung động -->
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Phần 5: Ví dụ minh họa -->
                <div class="p-6 md:p-8 bg-blue-50">
                    <h2 class="text-xl font-bold text-blue-900 border-b-2 border-blue-200 pb-2 mb-6">
                        PHẦN 5: VÍ DỤ MINH HỌA (QUÁN CÀ PHÊ "PHA LOÃNG")
                    </h2>
                    <div class="space-y-4 text-sm text-gray-700">
                        <p>Hãy tưởng tượng công ty là một <strong>quán cà phê trị giá 100 triệu VND</strong>, được chia làm <strong>10 "Phần"</strong> (tương đương 10 cổ phiếu). Bạn đang sở hữu 1 "Phần", trị giá 10 triệu.</p>
                        <p>Quán muốn huy động thêm vốn (phát hành thêm) bằng cách tạo ra <strong>10 "Phần" mới</strong> (tỷ lệ 1:1) và bán cho các chủ sở hữu cũ (cổ đông hiện hữu) với <strong>giá ưu đãi chỉ 5 triệu / Phần</strong>.</p>
                        <ul class="list-disc list-inside space-y-3 pl-4">
                            <li>
                                <strong>Pha loãng là gì?</strong> Ngay khi quyết định này được đưa ra, tổng số "Phần" của quán sẽ là 20 (10 cũ + 10 mới). Giá trị mỗi "Phần" của bạn ngay lập tức bị "pha loãng" (giảm) vì giá trị 100 triệu ban đầu của quán giờ phải chia cho 20 "Phần".
                            </li>
                            <li>
                                <strong>✅ Kịch bản THỰC HIỆN QUYỀN:</strong> Bạn nộp 5 triệu, mua thêm 1 "Phần" mới. 
                                <br>-> Bạn có tổng cộng 2 "Phần" (trên tổng 20) và vẫn giữ 1/10 tỷ lệ sở hữu quán. Bạn đã dùng 5 triệu tiền mặt để đổi lấy 1 "Phần" (tài sản) có giá trị cao hơn. <strong class="text-green-700">Bạn đã bảo toàn được tài sản của mình.</strong>
                            </li>
                            <li>
                                <strong>❌ Kịch bản TỪ BỎ QUYỀN:</strong> Bạn không nộp tiền. Người khác sẽ mua "Phần" đó.
                                <br>-> Bạn vẫn chỉ có 1 "Phần", nhưng tỷ lệ sở hữu của bạn tại quán đã <strong class="text-red-700">giảm vĩnh viễn</strong> (chỉ còn 1/20). Bạn đã mất đi "cơ hội" mua tài sản (Phần) với giá rẻ. Khoản "thiệt hại" chính là <strong>5 triệu</strong> (chênh lệch giữa giá trị đáng lẽ bạn được hưởng và giá mua ưu đãi) mà bạn đã "từ chối".
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            <!-- HẾT KỊCH BẢN 1 -->

            <!-- KỊCH BẢN 2: CHỈ CÓ CỔ TỨC -->
            <div id="dividendOnlyAnalysis" class="hidden">
                <!-- Phần 3: So sánh quyết định -->
                <div class="p-6 md:p-8">
                    <h2 class="text-xl font-bold text-blue-900 border-b-2 border-blue-200 pb-2 mb-6">
                        PHẦN 3: SO SÁNH QUYẾT ĐỊNH (CHỈ CHIA CỔ TỨC/THƯỞNG)
                    </h2>
                    <div class="overflow-x-auto">
                        <table class="min-w-full border border-gray-200 rounded-lg">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="p-4 text-left text-sm font-semibold text-gray-700">Tiêu chí so sánh</th>
                                    <th class="p-4 text-left text-sm font-semibold text-white bg-blue-600">
                                        ✅ MUA/NẮM GIỮ TRƯỚC GDKHQ
                                    </th>
                                    <th class="p-4 text-left text-sm font-semibold text-white bg-orange-500">
                                        ➡️ MUA SAU GDKHQ
                                    </th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                <tr>
                                    <td class="p-4 font-medium text-gray-600">Số lượng CP dự định mua/nắm giữ</td>
                                    <td id="div-val-n1" class="p-4"></td>
                                    <td id="div-val-n2" class="p-4"></td>
                                </tr>
                                <tr>
                                    <td class="p-4 font-medium text-gray-600">Giá mua / CP (trung bình)</td>
                                    <td id="div-val-price1" class="p-4 font-semibold"></td>
                                    <td id="div-val-price2" class="p-4 font-semibold"></td>
                                </tr>
                                <tr class="bg-gray-50">
                                    <td class="p-4 font-bold text-gray-800">Tổng vốn bỏ ra</td>
                                    <td id="div-val-capital1" class="p-4 font-bold text-lg"></td>
                                    <td id="div-val-capital2" class="p-4 font-bold text-lg"></td>
                                </tr>
                                <tr>
                                    <td class="p-4 font-medium text-gray-600">Tiền mặt nhận (Cổ tức)</td>
                                    <td id="div-val-cash-in1" class="p-4 text-green-600 font-semibold"></td>
                                    <td id="div-val-cash-in2" class="p-4">0 VND</td>
                                </tr>
                                <tr>
                                    <td class="p-4 font-medium text-gray-600">Số CP thưởng/cổ tức</td>
                                    <td id="div-val-bonus1" class="p-4 text-green-600 font-semibold"></td>
                                    <td id="div-val-bonus2" class="p-4">0 CP</td>
                                </tr>
                                <tr class="bg-gray-50">
                                    <td class="p-4 font-bold text-gray-800">Tổng số CP sở hữu</td>
                                    <td id="div-val-total-n1" class="p-4 font-bold text-lg text-blue-700"></td>
                                    <td id="div-val-total-n2" class="p-4 font-bold text-lg text-orange-700"></td>
                                </tr>
                                <tr class="bg-blue-50 border-t-2 border-blue-200">
                                    <td class="p-4 font-bold text-blue-800">
                                        Tổng giá trị tài sản<br>
                                        <span class="text-xs font-normal">(Tổng CP * Giá P' + Tiền mặt ròng)</span>
                                    </td>
                                    <td id="div-val-asset1" class="p-4 font-bold text-2xl text-blue-600"></td>
                                    <td id="div-val-asset2" class="p-4 font-bold text-2xl text-orange-600"></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            
                <!-- Phần 4: Diễn giải & Khuyến nghị (Cổ tức) -->
                <div class="p-6 md:p-8">
                    <h2 class="text-xl font-bold text-blue-900 border-b-2 border-blue-200 pb-2 mb-6">
                        PHẦN 4: DIỄN GIẢI KỊCH BẢN (CHỈ CHIA CỔ TỨC/THƯỞNG)
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                        <!-- Kịch bản 1: Mua trước -->
                        <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded-r-lg shadow">
                            <h4 class="font-bold text-lg text-blue-800 mb-2">✅ KỊCH BẢN 1: MUA TRƯỚC GDKHQ</h4>
                            <p id="div-dynamic-reco-1" class="text-sm text-gray-700 space-y-2">
                                <!-- Nội dung động -->
                            </p>
                        </div>
                        <!-- Kịch bản 2: Mua sau -->
                        <div class="bg-orange-50 border-l-4 border-orange-500 p-4 rounded-r-lg shadow">
                            <h4 class="font-bold text-lg text-orange-800 mb-2">➡️ KỊCH BẢN 2: MUA SAU GDKHQ</h4>
                            <p id="div-dynamic-reco-2" class="text-sm text-gray-700 space-y-2">
                                <!-- Nội dung động -->
                            </p>
                        </div>
                    </div>
                    <div class="mt-6 bg-gray-100 p-4 rounded-lg text-center">
                        <h4 class="font-semibold text-lg text-gray-800">KẾT LUẬN</h4>
                        <p id="div-dynamic-conclusion" class="text-sm text-gray-700 mt-2">
                            <!-- Nội dung động -->
                        </p>
                    </div>
                </div>
            </div>
            <!-- HẾT KỊCH BẢN 2 -->


            <!-- Phần 6: Lưu ý (Chung cho cả 2) -->
            <div class="p-6 md:p-8 border-t border-gray-200 bg-gray-50">
                <h2 class="text-lg font-bold text-gray-700 mb-3">PHẦN 6: LƯU Ý QUAN TRỌNG</h2>
                <ul class="list-disc list-inside text-sm text-gray-600 space-y-2">
                    <li>Các tính toán trên đây chỉ mang tính chất tham khảo, dựa trên lý thuyết về việc điều chỉnh giá tại ngày GDKHQ.</li>
                    <li>Giá trị thị trường của cổ phiếu sau ngày GDKHQ sẽ biến động theo cung cầu thực tế, không nhất thiết bằng đúng giá điều chỉnh P'.</li>
                    <li>Quyết định cuối cùng phụ thuộc vào đánh giá của nhà đầu tư về tiềm năng tăng trưởng của doanh nghiệp và chiến lược đầu tư cá nhân.</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        document.getElementById('calculateBtn').addEventListener('click', function() {
            // --- 1. LẤY DỮ LIỆU ĐẦU VÀO ---
            const N = parseFloat(document.getElementById('currentShares').value) || 0;
            const P = parseFloat(document.getElementById('priceBefore').value) || 0;
            const C = parseFloat(document.getElementById('cashDividend').value) || 0;
            const R1_percent = parseFloat(document.getElementById('stockDividendRatio').value) || 0;
            const Ratio_Old = parseFloat(document.getElementById('rightsRatioOld').value) || 0;
            const Ratio_New = parseFloat(document.getElementById('rightsRatioNew').value) || 0;
            const Pa = parseFloat(document.getElementById('issuePrice').value) || 0;

            // --- 2. KIỂM TRA ĐẦU VÀO CƠ BẢN ---
            if (P === 0 || N === 0) {
                // Sử dụng một thông báo tùy chỉnh (có thể thay bằng modal)
                alert("Vui lòng nhập Số lượng cổ phiếu và Giá trước GDKHQ.");
                return;
            }
            
            // --- 3. TÍNH TOÁN CÁC TỶ LỆ ---
            const R1 = R1_percent / 100; // Tỷ lệ cổ tức/thưởng bằng CP
            const R2 = (Ratio_Old > 0 && Ratio_New > 0) ? (Ratio_New / Ratio_Old) : 0; // Tỷ lệ quyền mua

            // --- 4. TÍNH GIÁ ĐIỀU CHỈNH (P') ---
            const denominator = 1 + R1 + R2;
            let P_prime = P; // Mặc định
            
            // Chỉ tính Pa khi có quyền mua (R2 > 0). Nếu không, Pa = 0
            const effective_Pa = R2 > 0 ? Pa : 0;
            
            if (denominator > 0) {
                P_prime = (P + effective_Pa * R2 - C) / denominator;
            }

            // --- 5. ĐỊNH DẠNG SỐ LIỆU (Formatter) ---
            const formatVND = (value) => new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(value);
            const formatCP = (value) => new Intl.NumberFormat('vi-VN', { maximumFractionDigits: 2 }).format(value) + ' CP';

            // --- 6. HIỂN THỊ PHẦN 2 (CHUNG) ---
            document.getElementById('adjustedPriceResult').textContent = formatVND(P_prime);
            document.getElementById('explanation').innerHTML = `
                <p><strong>Trong đó:</strong></p>
                <p><strong>P</strong> (Giá trước GDKHQ): ${formatVND(P)}</p>
                <p><strong>Pa</strong> (Giá phát hành): ${formatVND(effective_Pa)}</p>
                <p><strong>C</strong> (Cổ tức tiền): ${formatVND(C)}</p>
                <p><strong>R1</strong> (Tỷ lệ thưởng CP): ${R1_percent}% hay ${R1.toFixed(2)}</p>
                <p><strong>R2</strong> (Tỷ lệ quyền mua): ${R2 > 0 ? (Ratio_New + '/' + Ratio_Old) : '0'} hay ${R2.toFixed(4)}</p>
                <p class="font-semibold mt-2">P' = (${formatVND(P)} + ${formatVND(effective_Pa)} * ${R2.toFixed(4)} - ${formatVND(C)}) / (1 + ${R1.toFixed(2)} + ${R2.toFixed(4)})</p>
                <p class="font-semibold">P' = ${formatVND(P_prime)}</p>
            `;
            
            // --- 7. LOGIC PHÂN NHÁNH KỊCH BẢN ---
            const isRightsIssue = (R2 > 0 && Pa > 0);
            
            // Ẩn cả 2 khối phân tích trước
            document.getElementById('rightsIssueAnalysis').style.display = 'none';
            document.getElementById('dividendOnlyAnalysis').style.display = 'none';

            if (isRightsIssue) {
                // --- KỊCH BẢN 1: CÓ QUYỀN MUA ---
                
                // Tính toán
                const N_bonus = N * R1;
                const N_new = N * R2;
                const N_total_1 = N + N_bonus + N_new;
                const N_total_2 = N + N_bonus;
                const Cash_in = N * C;
                const Cash_out = N_new * Pa;
                const Net_cash_1 = Cash_in - Cash_out;
                const Net_cash_2 = Cash_in;
                const Total_Benefit = N_new * (P_prime - Pa);

                // Điền bảng (Phần 3)
                document.getElementById('val-n1').textContent = formatCP(N);
                document.getElementById('val-n2').textContent = formatCP(N);
                document.getElementById('val-bonus1').textContent = formatCP(N_bonus);
                document.getElementById('val-bonus2').textContent = formatCP(N_bonus);
                document.getElementById('val-new1').textContent = formatCP(N_new);
                document.getElementById('val-total-n1').textContent = formatCP(N_total_1);
                document.getElementById('val-total-n2').textContent = formatCP(N_total_2);
                document.getElementById('val-cash-in1').textContent = formatVND(Cash_in);
                document.getElementById('val-cash-in2').textContent = formatVND(Cash_in);
                document.getElementById('val-cash-out1').textContent = `-${formatVND(Cash_out)}`;
                document.getElementById('val-net-cash1').textContent = formatVND(Net_cash_1);
                document.getElementById('val-net-cash2').textContent = formatVND(Net_cash_2);
                document.getElementById('val-benefit').textContent = formatVND(Total_Benefit);
                document.getElementById('val-loss').textContent = `-${formatVND(Total_Benefit)}`;
                
                // Điền diễn giải (Phần 4)
                const benefitFormatted = `<strong class='text-green-700'>${formatVND(Total_Benefit)}</strong>`;
                const paFormatted = `<strong>${formatVND(Pa)}</strong>`;
                const pPrimeFormatted = `<strong>${formatVND(P_prime)}</strong>`;
                const nNewFormatted = `<strong>${formatCP(N_new)}</strong>`;

                document.getElementById('dynamic-reco-1').innerHTML = 
                    `<div>Việc phải nộp thêm tiền để mua ${nNewFormatted} có thể khiến bạn băn khoăn.</div>
                    <div>Tuy nhiên, đây là một <strong>cơ hội</strong>: bạn đang dùng tiền mặt để đổi lấy tài sản (cổ phiếu) với giá ${paFormatted}, thấp hơn nhiều so với giá trị hợp lý của nó (là ${pPrimeFormatted}).</div>
                    <div>Khoản lợi ích tức thời ${benefitFormatted} chính là 'phần thưởng' cho hành động này. Đây là hành động <strong class='text-green-700'>bảo toàn giá trị tài sản</strong>.</div>`;

                document.getElementById('dynamic-reco-2').innerHTML = 
                    `<div>Nếu bạn từ bỏ quyền (không nộp tiền), tài sản của bạn vẫn bị pha loãng (vì giá P' đã giảm), nhưng bạn lại <strong class='text-red-700'>đánh mất</strong> khoản lợi ích ${benefitFormatted} ở trên.</div>
                    <div>Điều này dẫn đến một khoản <strong class='text-red-700'>thiệt hại thực sự</strong> do giá trị tài sản ròng của bạn bị giảm sút.</div>`;

                // Hiển thị khối phân tích Quyền Mua
                document.getElementById('rightsIssueAnalysis').style.display = 'block';

            } else {
                // --- KỊCH BẢN 2: CHỈ CHIA CỔ TỨC/THƯỞNG ---
                
                // Tính toán
                const N_bonus = N * R1;
                const Cash_in = N * C;
                const TotalCapital_1 = N * P;
                const TotalCapital_2 = N * P_prime;
                const TotalShares_1 = N + N_bonus;
                const TotalShares_2 = N;

                // Tổng giá trị tài sản (Key)
                const TotalAssetValue_1 = (TotalShares_1 * P_prime) + Cash_in;
                const TotalAssetValue_2 = TotalShares_2 * P_prime; // Chính là bằng TotalCapital_2

                // Điền bảng (Phần 3)
                document.getElementById('div-val-n1').textContent = formatCP(N);
                document.getElementById('div-val-n2').textContent = formatCP(N);
                document.getElementById('div-val-price1').textContent = formatVND(P);
                document.getElementById('div-val-price2').textContent = formatVND(P_prime);
                document.getElementById('div-val-capital1').textContent = formatVND(TotalCapital_1);
                document.getElementById('div-val-capital2').textContent = formatVND(TotalCapital_2);
                document.getElementById('div-val-cash-in1').textContent = `+${formatVND(Cash_in)}`;
                document.getElementById('div-val-bonus1').textContent = `+${formatCP(N_bonus)}`;
                document.getElementById('div-val-total-n1').textContent = formatCP(TotalShares_1);
                document.getElementById('div-val-total-n2').textContent = formatCP(TotalShares_2);
                document.getElementById('div-val-asset1').textContent = formatVND(TotalAssetValue_1);
                document.getElementById('div-val-asset2').textContent = formatVND(TotalAssetValue_2);

                // Điền diễn giải (Phần 4)
                document.getElementById('div-dynamic-reco-1').innerHTML = 
                    `<div>Bạn bỏ ra <strong class="text-gray-800">${formatVND(TotalCapital_1)}</strong> để mua ${formatCP(N)} ở giá P.</div>
                    <div>Sau GDKHQ, bạn nhận về ${formatVND(Cash_in)} tiền mặt và ${formatCP(N_bonus)}.</div>
                    <div>Tổng tài sản của bạn (CP quy đổi theo giá P' + Tiền mặt) là <strong class="text-blue-700">${formatVND(TotalAssetValue_1)}</strong>.</div>`;
                
                document.getElementById('div-dynamic-reco-2').innerHTML =
                    `<div>Bạn đợi sau GDKHQ, mua đúng ${formatCP(N)} với giá P' đã điều chỉnh.</div>
                    <div>Tổng vốn bạn bỏ ra chỉ là <strong class="text-gray-800">${formatVND(TotalCapital_2)}</strong>.</div>
                    <div>Tổng tài sản của bạn (chỉ có CP) cũng là <strong class="text-orange-700">${formatVND(TotalAssetValue_2)}</strong>.</div>`;

                document.getElementById('div-dynamic-conclusion').innerHTML =
                    `Về lý thuyết, tổng giá trị tài sản của hai kịch bản là <strong>tương đương nhau</strong>. 
                    Việc mua trước GDKHQ chỉ đơn giản là "nhận" cổ tức, và giá cổ phiếu bị điều chỉnh giảm tương ứng.
                    Quyết định phụ thuộc vào việc bạn có muốn nhận cổ tức (tiền mặt/CP) hay không, hoặc các yếu tố về thuế TNCN (nếu có).`;

                // Hiển thị khối phân tích Cổ tức
                document.getElementById('dividendOnlyAnalysis').style.display = 'block';
            }

            // --- 8. HIỂN THỊ KHỐI KẾT QUẢ CHUNG ---
            document.getElementById('results').style.display = 'block';
            document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
        });
    </script>

</body>
</html>

